// Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package com.intellij.lang.javascript.flex.run;

import com.intellij.ide.browsers.BrowserFamily;
import com.intellij.ide.browsers.BrowserSelector;
import com.intellij.ide.browsers.WebBrowser;
import com.intellij.ide.browsers.WebBrowserManager;
import com.intellij.lang.javascript.flex.FlexBundle;
import com.intellij.openapi.fileChooser.FileChooserDescriptor;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.ui.TextFieldWithBrowseButton;
import com.intellij.openapi.util.SystemInfo;
import com.intellij.openapi.util.io.FileUtil;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.openapi.wm.IdeFocusManager;
import com.intellij.ui.components.JBCheckBox;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import org.jetbrains.annotations.Nullable;

import javax.swing.ButtonGroup;
import javax.swing.JComponent;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

public class FlexLauncherDialog extends DialogWrapper {
  private final JPanel myMainPanel;

  private final JRadioButton myDefaultOSApplicationRadioButton;

  private final JRadioButton myBrowserRadioButton;
  private final JPanel myBrowserSelectorPanel;
  private final BrowserSelector myBrowserSelector;

  private final JRadioButton myPlayerRadioButton;
  private final TextFieldWithBrowseButton myPlayerTextWithBrowse;
  private final JBCheckBox myNewPlayerInstanceCheckBox;

  private final Project myProject;

  public FlexLauncherDialog(final Project project, final LauncherParameters launcherParameters) {
    super(project);
    myProject = project;
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myMainPanel = new JPanel();
      myMainPanel.setLayout(new GridLayoutManager(5, 2, new Insets(0, 0, 0, 0), -1, -1));
      myDefaultOSApplicationRadioButton = new JRadioButton();
      myDefaultOSApplicationRadioButton.setText("System default application");
      myDefaultOSApplicationRadioButton.setMnemonic('S');
      myDefaultOSApplicationRadioButton.setDisplayedMnemonicIndex(0);
      myMainPanel.add(myDefaultOSApplicationRadioButton,
                      new GridConstraints(0, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                          GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer1 = new Spacer();
      myMainPanel.add(spacer1, new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      myBrowserRadioButton = new JRadioButton();
      myBrowserRadioButton.setText("Browser:");
      myBrowserRadioButton.setMnemonic('B');
      myBrowserRadioButton.setDisplayedMnemonicIndex(0);
      myMainPanel.add(myBrowserRadioButton, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer2 = new Spacer();
      myMainPanel.add(spacer2, new GridConstraints(4, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      myPlayerRadioButton = new JRadioButton();
      myPlayerRadioButton.setText("Flash Player:");
      myPlayerRadioButton.setMnemonic('F');
      myPlayerRadioButton.setDisplayedMnemonicIndex(0);
      myMainPanel.add(myPlayerRadioButton, new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                               GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                               GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myPlayerTextWithBrowse = new TextFieldWithBrowseButton();
      myMainPanel.add(myPlayerTextWithBrowse,
                      new GridConstraints(2, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                          GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED, new Dimension(250, -1),
                                          null, null, 0, false));
      myBrowserSelectorPanel = new JPanel();
      myBrowserSelectorPanel.setLayout(new BorderLayout(0, 0));
      myMainPanel.add(myBrowserSelectorPanel, new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                  GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                  GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0, false));
      myNewPlayerInstanceCheckBox = new JBCheckBox();
      myNewPlayerInstanceCheckBox.setText("New instance");
      myNewPlayerInstanceCheckBox.setMnemonic('N');
      myNewPlayerInstanceCheckBox.setDisplayedMnemonicIndex(0);
      myMainPanel.add(myNewPlayerInstanceCheckBox, new GridConstraints(3, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                       GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED,
                                                                       null, null, null, 3, false));
      ButtonGroup buttonGroup;
      buttonGroup = new ButtonGroup();
      buttonGroup.add(myDefaultOSApplicationRadioButton);
      buttonGroup.add(myBrowserRadioButton);
      buttonGroup.add(myPlayerRadioButton);
    }
    setTitle(FlexBundle.message("launch.with.title"));

    myBrowserSelector = new BrowserSelector(false);
    myBrowserSelectorPanel.add(BorderLayout.CENTER, myBrowserSelector.getMainComponent());
    initRadioButtons();
    initControls(launcherParameters);
    updateControls();

    init();
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myMainPanel; }

  private void initRadioButtons() {
    myDefaultOSApplicationRadioButton.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        updateControls();
      }
    });
    myBrowserRadioButton.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        updateControls();
        IdeFocusManager.getInstance(myProject).requestFocus(myBrowserSelector.getMainComponent(), true);
      }
    });
    myPlayerRadioButton.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        updateControls();
        IdeFocusManager.getInstance(myProject).requestFocus(myPlayerTextWithBrowse.getTextField(), true);
      }
    });
  }

  private void initControls(final LauncherParameters launcherParameters) {
    final LauncherParameters.LauncherType launcherType = launcherParameters.getLauncherType();
    myDefaultOSApplicationRadioButton.setSelected(launcherType == LauncherParameters.LauncherType.OSDefault);
    myBrowserRadioButton.setSelected(launcherType == LauncherParameters.LauncherType.Browser);
    myPlayerRadioButton.setSelected(launcherType == LauncherParameters.LauncherType.Player);

    myBrowserSelector.setSelected(launcherParameters.getBrowser());

    myPlayerTextWithBrowse.setText(FileUtil.toSystemDependentName(launcherParameters.getPlayerPath()));
    myPlayerTextWithBrowse.addBrowseFolderListener(myProject, new FileChooserDescriptor(true, true, false, false, false, false) {
      @Override
      public boolean isFileSelectable(final @Nullable VirtualFile file) {
        return file != null &&
               (SystemInfo.isMac && file.isDirectory() && "app".equalsIgnoreCase(file.getExtension()) || !file.isDirectory());
      }
    });
    myNewPlayerInstanceCheckBox.setVisible(SystemInfo.isMac);
  }

  private void updateControls() {
    myBrowserSelector.getMainComponent().setEnabled(myBrowserRadioButton.isSelected());

    myPlayerTextWithBrowse.setEnabled(myPlayerRadioButton.isSelected());
    myNewPlayerInstanceCheckBox.setEnabled(myPlayerRadioButton.isSelected());
  }

  @Override
  protected JComponent createCenterPanel() {
    return myMainPanel;
  }

  public LauncherParameters getLauncherParameters() {
    final LauncherParameters.LauncherType launcherType = myPlayerRadioButton.isSelected()
                                                         ? LauncherParameters.LauncherType.Player
                                                         : myBrowserRadioButton.isSelected()
                                                           ? LauncherParameters.LauncherType.Browser
                                                           : LauncherParameters.LauncherType.OSDefault;
    final WebBrowser browser = myBrowserSelector.getSelected();
    final WebBrowser notNullBrowser = browser == null ? WebBrowserManager.getInstance().getFirstBrowser(BrowserFamily.FIREFOX)
                                                      : browser;
    final String playerPath = FileUtil.toSystemIndependentName(myPlayerTextWithBrowse.getText().trim());
    final boolean isNewPlayerInstance = myNewPlayerInstanceCheckBox.isSelected();
    return new LauncherParameters(launcherType, notNullBrowser, playerPath, isNewPlayerInstance);
  }
}

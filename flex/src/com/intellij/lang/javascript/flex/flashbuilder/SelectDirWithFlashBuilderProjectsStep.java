// Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package com.intellij.lang.javascript.flex.flashbuilder;

import com.intellij.CommonBundle;
import com.intellij.ide.util.projectWizard.WizardContext;
import com.intellij.lang.javascript.flex.FlexBundle;
import com.intellij.openapi.fileChooser.FileChooserDescriptor;
import com.intellij.openapi.fileChooser.FileChooserDescriptorFactory;
import com.intellij.openapi.options.ConfigurationException;
import com.intellij.openapi.ui.LabeledComponentNoThrow;
import com.intellij.openapi.ui.Messages;
import com.intellij.openapi.ui.TextFieldWithBrowseButton;
import com.intellij.openapi.util.io.FileUtil;
import com.intellij.openapi.vfs.LocalFileSystem;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.projectImport.ProjectFormatPanel;
import com.intellij.projectImport.ProjectImportWizardStep;
import com.intellij.ui.DocumentAdapter;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import com.intellij.util.PathUtil;
import org.jetbrains.annotations.NotNull;

import javax.swing.AbstractButton;
import javax.swing.BorderFactory;
import javax.swing.Icon;
import javax.swing.JCheckBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;
import javax.swing.border.TitledBorder;
import javax.swing.event.DocumentEvent;
import java.awt.Dimension;
import java.awt.Insets;
import java.io.File;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Objects;
import java.util.ResourceBundle;

public class SelectDirWithFlashBuilderProjectsStep extends ProjectImportWizardStep {
  private final JPanel myMainPanel;
  private final LabeledComponentNoThrow<TextFieldWithBrowseButton> myInitialPathComponent;
  private final LabeledComponentNoThrow<TextFieldWithBrowseButton> myExtractPathComponent;
  private final LabeledComponentNoThrow<JTextField> myProjectNameComponent;
  private final LabeledComponentNoThrow<TextFieldWithBrowseButton> myProjectLocationComponent;
  private final JLabel myMultiProjectNote;
  private final JCheckBox myCreateSubfolderCheckBox;
  private final ProjectFormatPanel myProjectFormatPanel;

  public SelectDirWithFlashBuilderProjectsStep(final WizardContext context) {
    super(context);
    {
      myProjectFormatPanel = new ProjectFormatPanel();
    }
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myMainPanel = new JPanel();
      myMainPanel.setLayout(new GridLayoutManager(9, 1, new Insets(0, 0, 0, 0), -1, -1));
      myMainPanel.setBorder(BorderFactory.createTitledBorder(BorderFactory.createEtchedBorder(), null, TitledBorder.DEFAULT_JUSTIFICATION,
                                                             TitledBorder.DEFAULT_POSITION, null, null));
      final Spacer spacer1 = new Spacer();
      myMainPanel.add(spacer1, new GridConstraints(8, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      myInitialPathComponent = new LabeledComponentNoThrow();
      myInitialPathComponent.setComponentClass("com.intellij.openapi.ui.TextFieldWithBrowseButton");
      myInitialPathComponent.setText(this.$$$getMessageFromBundle$$$("messages/FlexBundle", "flash.builder.workspace.or.project.dir"));
      myMainPanel.add(myInitialPathComponent,
                      new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0,
                                          false));
      myMainPanel.add(myProjectFormatPanel.$$$getRootComponent$$$(),
                      new GridConstraints(7, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0,
                                          false));
      myProjectNameComponent = new LabeledComponentNoThrow();
      myProjectNameComponent.setComponentClass("javax.swing.JTextField");
      myProjectNameComponent.setText("Project name");
      myMainPanel.add(myProjectNameComponent,
                      new GridConstraints(3, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0,
                                          false));
      myProjectLocationComponent = new LabeledComponentNoThrow();
      myProjectLocationComponent.setComponentClass("com.intellij.openapi.ui.TextFieldWithBrowseButton");
      myProjectLocationComponent.setText(this.$$$getMessageFromBundle$$$("messages/FlexBundle", "project.files.location"));
      myMainPanel.add(myProjectLocationComponent,
                      new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0,
                                          false));
      final Spacer spacer2 = new Spacer();
      myMainPanel.add(spacer2, new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(-1, 15), null, 0, false));
      myCreateSubfolderCheckBox = new JCheckBox();
      this.$$$loadButtonText$$$(myCreateSubfolderCheckBox,
                                this.$$$getMessageFromBundle$$$("messages/FlexBundle", "extract.single.to.subfolder.0"));
      myMainPanel.add(myCreateSubfolderCheckBox, new GridConstraints(6, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                     GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                     null, null, null, 0, false));
      myExtractPathComponent = new LabeledComponentNoThrow();
      myExtractPathComponent.setComponentClass("com.intellij.openapi.ui.TextFieldWithBrowseButton");
      myExtractPathComponent.setText(this.$$$getMessageFromBundle$$$("messages/FlexBundle", "folder.to.unzip.several.FB.projects"));
      myMainPanel.add(myExtractPathComponent,
                      new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0,
                                          false));
      myMultiProjectNote = new JLabel();
      this.$$$loadLabelText$$$(myMultiProjectNote,
                               this.$$$getMessageFromBundle$$$("messages/FlexBundle", "note.multiple.projects.extract.to.subfolders"));
      myMainPanel.add(myMultiProjectNote, new GridConstraints(5, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                              GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null,
                                                              null, null, 0, false));
    }
    setupInitialPathComponent();

    myExtractPathComponent.setVisible(false);
    myExtractPathComponent.getComponent()
      .addBrowseFolderListener(context.getProject(), FileChooserDescriptorFactory.createSingleFolderDescriptor());

    final boolean creatingNewProject = context.isCreatingNewProject();
    myProjectNameComponent.setVisible(creatingNewProject);
    myProjectLocationComponent.setVisible(creatingNewProject);
    myProjectLocationComponent.getComponent()
      .addBrowseFolderListener(context.getProject(), FileChooserDescriptorFactory.createSingleFolderDescriptor());
    myProjectFormatPanel.getPanel().setVisible(creatingNewProject);

    myMultiProjectNote.setVisible(false);
    myCreateSubfolderCheckBox.setVisible(false);
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadLabelText$$$(JLabel component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setDisplayedMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myMainPanel; }

  private void setupInitialPathComponent() {
    myInitialPathComponent.getComponent().getTextField().getDocument().addDocumentListener(new DocumentAdapter() {
      @Override
      protected void textChanged(final @NotNull DocumentEvent e) {
        onInitialPathChanged();
      }
    });

    var descriptor = new FileChooserDescriptor(true, true, true, true, false, false) {
      @Override
      public Icon getIcon(final VirtualFile file) {
        // do not use Flash Builder specific icon for zip
        return !file.isDirectory() &&
               (FlashBuilderProjectFinder.hasFxpExtension(file.getPath()) || FlashBuilderProjectFinder.isFlashBuilderProject(file))
               ? dressIcon(file, getBuilder().getIcon())
               : super.getIcon(file);
      }
    }
      .withFileFilter(file -> FlashBuilderProjectFinder.isFlashBuilderProject(file) ||
                              FlashBuilderProjectFinder.hasArchiveExtension(file.getPath()))
      .withTitle(FlexBundle.message("select.flash.builder.workspace.or.project"));

    var button = myInitialPathComponent.getComponent();
    button.addBrowseFolderListener(getWizardContext().getProject(), descriptor);
  }

  private void onInitialPathChanged() {
    final String path = myInitialPathComponent.getComponent().getText().trim();
    ((FlashBuilderImporter)getBuilder()).setInitiallySelectedPath(path);
    getWizardContext().requestWizardButtonsUpdate();

    final VirtualFile file = path.isEmpty() ? null : LocalFileSystem.getInstance().findFileByPath(path);

    final boolean isArchive = file != null && !file.isDirectory() && FlashBuilderProjectFinder.hasArchiveExtension(file.getPath());
    final boolean multiProjectArchive = isArchive && FlashBuilderProjectFinder.isMultiProjectArchive(file.getPath());

    if (getWizardContext().isCreatingNewProject()) {
      if (file != null) {
        final String suggestedProjectName = ((FlashBuilderImporter)getBuilder()).getSuggestedProjectName();
        myProjectNameComponent.getComponent().setText(suggestedProjectName);

        if (isArchive) {
          myProjectLocationComponent.setText(FlexBundle.message("project.location"));

          String dir = getWizardContext().getProjectFileDirectory();
          if (new File(dir).isFile()) {
            dir = PathUtil.getParentPath(dir);
          }
          myProjectLocationComponent.getComponent().setText(FileUtil.toSystemDependentName(dir + "/" + suggestedProjectName));
        }
        else {
          myProjectLocationComponent.setText(FlexBundle.message("project.files.location"));
          myProjectLocationComponent.getComponent()
            .setText(FileUtil.toSystemDependentName(file.isDirectory() ? file.getPath() : file.getParent().getPath()));
        }
      }

      myMultiProjectNote.setVisible(isArchive && multiProjectArchive);
      myCreateSubfolderCheckBox.setVisible(isArchive && !multiProjectArchive);
      myCreateSubfolderCheckBox
        .setText(FlexBundle.message("extract.single.to.subfolder.0", file == null ? "" : file.getNameWithoutExtension()));
    }
    else {
      myExtractPathComponent.setVisible(isArchive);
      if (isArchive) {
        myExtractPathComponent.setText(multiProjectArchive ? FlexBundle.message("folder.to.unzip.several.FB.projects")
                                                           : FlexBundle.message("folder.to.unzip.one.FB.project"));
        final String extractPath = multiProjectArchive ? getWizardContext().getProject().getBasePath()
                                                       : getWizardContext().getProject().getBasePath()
                                                         + "/" + file.getNameWithoutExtension();
        myExtractPathComponent.getComponent().setText(FileUtil.toSystemDependentName(extractPath));
      }
    }
  }

  @Override
  public JComponent getComponent() {
    return myMainPanel;
  }

  @Override
  public JComponent getPreferredFocusedComponent() {
    return myInitialPathComponent.getComponent().getTextField();
  }

  @Override
  public void updateStep() {
    if (getWizardContext().isProjectFileDirectorySet() && myInitialPathComponent.getComponent().getText().isEmpty()) {
      myInitialPathComponent.getComponent().setText(FileUtil.toSystemDependentName(getWizardContext().getProjectFileDirectory()));
    }
  }

  @Override
  public void updateDataModel() {
    final FlashBuilderImporter builder = (FlashBuilderImporter)getBuilder();
    builder.setExtractToSubfolder(myCreateSubfolderCheckBox.isSelected());
    builder.setExtractPath(FileUtil.toSystemIndependentName(myExtractPathComponent.getComponent().getText().trim()));

    getWizardContext().setProjectName(myProjectNameComponent.getComponent().getText().trim());
    getWizardContext()
      .setProjectFileDirectory(FileUtil.toSystemIndependentName(myProjectLocationComponent.getComponent().getText().trim()));

    myProjectFormatPanel.updateData(getWizardContext());
  }

  @Override
  public boolean validate() throws ConfigurationException {
    final String path = myInitialPathComponent.getComponent().getText().trim();
    if (path.isEmpty()) {
      throw new ConfigurationException(FlexBundle.message("specify.flash.builder.workspace.or.project.dir"), CommonBundle.getErrorTitle());
    }
    final VirtualFile file = LocalFileSystem.getInstance().refreshAndFindFileByPath(path);
    if (file == null) {
      throw new ConfigurationException(FlexBundle.message("file.or.folder.not.found", path), CommonBundle.getErrorTitle());
    }

    if (file.isDirectory()) {
      final List<String> projectPaths = new ArrayList<>();
      // false if user cancelled
      final boolean ok = FlashBuilderProjectFinder.collectAllProjectPaths(getWizardContext().getProject(), projectPaths, path);

      if (ok) {
        if (projectPaths.isEmpty()) {
          throw new ConfigurationException(FlexBundle.message("flash.builder.projects.not.found.in"), CommonBundle.getErrorTitle());
        }

        ((FlashBuilderImporter)getBuilder()).setList(projectPaths);
      }

      return ok && checkProjectNameAndPath();
    }
    else {
      if (FlashBuilderProjectFinder.hasArchiveExtension(file.getPath())) {
        FlashBuilderProjectFinder.checkArchiveContainsFBProject(file.getPath());
        final File dir = new File(getWizardContext().isCreatingNewProject()
                                  ? myProjectLocationComponent.getComponent().getText().trim()
                                  : myExtractPathComponent.getComponent().getText().trim());
        if (dir.isDirectory() && Objects.requireNonNull(dir.list()).length > 0) {
          final String title = FlexBundle.message("dialog.title.import.from.flash.builder", getWizardContext().getPresentationName());
          if (Messages.YES !=
              Messages.showYesNoDialog(myMainPanel, FlexBundle.message("folder.not.empty", dir.getPath()), title,
                                       Messages.getWarningIcon())) {
            return false;
          }
        }
      }
      else if (!FlashBuilderProjectFinder.isFlashBuilderProject(file)) {
        throw new ConfigurationException(FlexBundle.message("not.flash.builder.project"), CommonBundle.getErrorTitle());
      }

      ((FlashBuilderImporter)getBuilder()).setList(Collections.singletonList(path));

      return checkProjectNameAndPath();
    }
  }

  private boolean checkProjectNameAndPath() throws ConfigurationException {
    if (!getWizardContext().isCreatingNewProject()) return true;

    if (myProjectNameComponent.getComponent().getText().trim().isEmpty()) {
      throw new ConfigurationException(FlexBundle.message("project.name.empty"));
    }

    if (myProjectLocationComponent.getComponent().getText().trim().isEmpty()) {
      throw new ConfigurationException(FlexBundle.message("project.path.empty"));
    }

    return true;
  }

  @Override
  public String getHelpId() {
    return "reference.dialogs.new.project.import.flex.page1";
  }
}

// Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package com.intellij.lang.javascript.flex.flexunit;

import com.intellij.execution.configurations.RuntimeConfigurationError;
import com.intellij.flex.model.bc.OutputType;
import com.intellij.flex.model.bc.TargetPlatform;
import com.intellij.lang.javascript.flex.FlexBundle;
import com.intellij.lang.javascript.flex.projectStructure.model.FlexBuildConfiguration;
import com.intellij.lang.javascript.flex.run.BCCombo;
import com.intellij.lang.javascript.flex.run.FlashRunConfigurationForm;
import com.intellij.lang.javascript.flex.run.FlashRunnerParameters;
import com.intellij.lang.javascript.flex.run.FlexLauncherDialog;
import com.intellij.lang.javascript.flex.run.LauncherParameters;
import com.intellij.openapi.module.Module;
import com.intellij.openapi.options.ConfigurationException;
import com.intellij.openapi.options.SettingsEditor;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.TextFieldWithBrowseButton;
import com.intellij.openapi.wm.IdeFocusManager;
import com.intellij.ui.EnumComboBoxModel;
import com.intellij.ui.IdeBorderFactory;
import com.intellij.ui.RawCommandLineEditor;
import com.intellij.ui.components.JBLabel;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import org.jetbrains.annotations.NotNull;

import javax.swing.AbstractButton;
import javax.swing.BorderFactory;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.border.TitledBorder;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.lang.reflect.Method;
import java.util.ResourceBundle;

public class FlexUnitRunConfigurationForm extends SettingsEditor<FlexUnitRunConfiguration> {
  private final JPanel myMainPanel;

  private final BCCombo myBCCombo;
  private final WhatToTestForm myWhatToTestForm;

  private final JCheckBox myShowLogCheckBox;
  private final JComboBox myLogLevelCombo;
  private final JLabel myLauncherParametersLabel;
  private final TextFieldWithBrowseButton myLauncherParametersTextWithBrowse;
  private final JCheckBox myRunTrustedCheckBox;
  private final JBLabel myEmulatorAdlOptionsLabel;
  private final RawCommandLineEditor myEmulatorAdlOptionsEditor;
  private final JLabel myAppDescriptorForEmulatorLabel;
  private final JComboBox myAppDescriptorForEmulatorCombo;

  private final Project myProject;

  private LauncherParameters myLauncherParameters;

  public FlexUnitRunConfigurationForm(final Project project) {
    myProject = project;
    {
      myBCCombo = new BCCombo(myProject);
      myWhatToTestForm = new WhatToTestForm(myProject,
                                            () -> {
                                              final java.lang.Module module = myBCCombo.getModule();
                                              if (module != null) return module;
                                              throw new RuntimeConfigurationError(FlexBundle.message("bc.not.specified"));
                                            },
                                            () -> {
                                              final FlexBuildConfiguration bc = myBCCombo.getBC();
                                              if (bc == null) throw new RuntimeConfigurationError(FlexBundle.message("bc.not.specified"));
                                              final FlexUnitSupport support = FlexUnitSupport.getSupport(bc, myBCCombo.getModule());
                                              if (support != null) return support;

                                              throw new RuntimeConfigurationError(
                                                FlexBundle.message("flexunit.not.found.for.bc", bc.getName()));
                                            }
      );
    }
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myMainPanel = new JPanel();
      myMainPanel.setLayout(new GridLayoutManager(4, 3, new Insets(0, 0, 0, 0), -1, -1));
      final JLabel label1 = new JLabel();
      label1.setText("Build configuration:");
      label1.setDisplayedMnemonic('C');
      label1.setDisplayedMnemonicIndex(6);
      myMainPanel.add(label1, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                  GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0,
                                                  false));
      final Spacer spacer1 = new Spacer();
      myMainPanel.add(spacer1, new GridConstraints(3, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      final Spacer spacer2 = new Spacer();
      myMainPanel.add(spacer2, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      myMainPanel.add(myBCCombo, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_NONE,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null,
                                                     null, null, 0, false));
      myMainPanel.add(myWhatToTestForm.$$$getRootComponent$$$(),
                      new GridConstraints(1, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                          GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null, 0,
                                          false));
      final JPanel panel1 = new JPanel();
      panel1.setLayout(new GridLayoutManager(5, 3, new Insets(0, 0, 0, 0), -1, -1));
      panel1.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithIndent");
      myMainPanel.add(panel1, new GridConstraints(2, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null,
                                                  null, 0, false));
      panel1.setBorder(IdeBorderFactory.PlainSmallWithIndent.createTitledBorder(BorderFactory.createEtchedBorder(), "Options",
                                                                                TitledBorder.DEFAULT_JUSTIFICATION,
                                                                                TitledBorder.DEFAULT_POSITION, null, null));
      myLogLevelCombo = new JComboBox();
      myLogLevelCombo.setToolTipText("Log messages with level equal or higher than specified will be shown");
      panel1.add(myLogLevelCombo, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                      GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                      new Dimension(100, -1), null, null, 0, false));
      final Spacer spacer3 = new Spacer();
      panel1.add(spacer3, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      myShowLogCheckBox = new JCheckBox();
      myShowLogCheckBox.setText("Show test log output:");
      myShowLogCheckBox.setMnemonic('W');
      myShowLogCheckBox.setDisplayedMnemonicIndex(3);
      panel1.add(myShowLogCheckBox, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                        GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JPanel panel2 = new JPanel();
      panel2.setLayout(new GridLayoutManager(1, 1, new Insets(0, 5, 0, 0), -1, -1));
      panel1.add(panel2, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                             0, false));
      myLauncherParametersLabel = new JLabel();
      myLauncherParametersLabel.setText("Launch with:");
      myLauncherParametersLabel.setDisplayedMnemonic('N');
      myLauncherParametersLabel.setDisplayedMnemonicIndex(3);
      panel2.add(myLauncherParametersLabel,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myLauncherParametersTextWithBrowse = new TextFieldWithBrowseButton();
      panel1.add(myLauncherParametersTextWithBrowse,
                 new GridConstraints(1, 1, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                     GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myRunTrustedCheckBox = new JCheckBox();
      this.$$$loadButtonText$$$(myRunTrustedCheckBox, this.$$$getMessageFromBundle$$$("messages/FlexBundle", "run.trusted"));
      panel1.add(myRunTrustedCheckBox, new GridConstraints(2, 0, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                           GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                           GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myEmulatorAdlOptionsEditor = new RawCommandLineEditor();
      myEmulatorAdlOptionsEditor.setDialogCaption("ADL Options");
      panel1.add(myEmulatorAdlOptionsEditor, new GridConstraints(3, 1, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                                 GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                 null, null, null, 0, false));
      myAppDescriptorForEmulatorCombo = new JComboBox();
      panel1.add(myAppDescriptorForEmulatorCombo,
                 new GridConstraints(4, 1, 1, 2, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                     GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JPanel panel3 = new JPanel();
      panel3.setLayout(new GridLayoutManager(1, 1, new Insets(0, 5, 0, 0), -1, -1));
      panel1.add(panel3, new GridConstraints(3, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                             0, false));
      myEmulatorAdlOptionsLabel = new JBLabel();
      myEmulatorAdlOptionsLabel.setText("ADL options:");
      myEmulatorAdlOptionsLabel.setDisplayedMnemonic('O');
      myEmulatorAdlOptionsLabel.setDisplayedMnemonicIndex(4);
      panel3.add(myEmulatorAdlOptionsLabel,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JPanel panel4 = new JPanel();
      panel4.setLayout(new GridLayoutManager(1, 1, new Insets(0, 5, 0, 0), -1, -1));
      panel1.add(panel4, new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                             0, false));
      myAppDescriptorForEmulatorLabel = new JLabel();
      myAppDescriptorForEmulatorLabel.setText("App descriptor:");
      myAppDescriptorForEmulatorLabel.setDisplayedMnemonic('P');
      myAppDescriptorForEmulatorLabel.setDisplayedMnemonicIndex(1);
      panel4.add(myAppDescriptorForEmulatorLabel,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      label1.setLabelFor(myBCCombo);
      myLauncherParametersLabel.setLabelFor(myLauncherParametersTextWithBrowse);
      myEmulatorAdlOptionsLabel.setLabelFor(myEmulatorAdlOptionsEditor);
      myAppDescriptorForEmulatorLabel.setLabelFor(myAppDescriptorForEmulatorCombo);
    }

    myBCCombo.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(final ActionEvent e) {
        myWhatToTestForm.updateOnBCChange(myBCCombo.getBC(), myBCCombo.getModule());
        myAppDescriptorForEmulatorCombo.repaint();
        updateControls();
      }
    });

    initLogLevelControls();
    initLaunchWithTextWithBrowse();

    FlashRunConfigurationForm.initAppDescriptorForEmulatorCombo(myAppDescriptorForEmulatorCombo,
                                                                () -> myBCCombo.getBC());
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myMainPanel; }

  private void initLogLevelControls() {
    myShowLogCheckBox.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        if (myShowLogCheckBox.isSelected()) {
          IdeFocusManager.getInstance(myProject).requestFocus(myLogLevelCombo, false);
        }
        updateControls();
      }
    });

    myLogLevelCombo.setModel(new EnumComboBoxModel<>(FlexUnitRunnerParameters.OutputLogLevel.class));
  }

  private void initLaunchWithTextWithBrowse() {
    myLauncherParametersTextWithBrowse.getTextField().setEditable(false);
    myLauncherParametersTextWithBrowse.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(final ActionEvent e) {
        final FlexLauncherDialog dialog = new FlexLauncherDialog(myProject, myLauncherParameters);
        if (dialog.showAndGet()) {
          myLauncherParameters = dialog.getLauncherParameters();
          updateControls();
        }
      }
    });
  }

  private void updateControls() {
    if (myShowLogCheckBox.isSelected()) {
      myLogLevelCombo.setEnabled(true);
      if (myLogLevelCombo.getSelectedItem() == null) {
        myLogLevelCombo.setSelectedItem(FlexUnitRunnerParameters.OutputLogLevel.values()[0]);
      }
    }
    else {
      myLogLevelCombo.setEnabled(false);
    }

    final FlexBuildConfiguration bc = myBCCombo.getBC();
    final boolean webPlatform = bc != null && bc.getTargetPlatform() == TargetPlatform.Web;
    final boolean mobilePlatform = bc != null && bc.getTargetPlatform() == TargetPlatform.Mobile;
    final boolean app = bc != null && bc.getOutputType() == OutputType.Application;

    myLauncherParametersLabel.setVisible(webPlatform);
    myLauncherParametersTextWithBrowse.setVisible(webPlatform);
    myRunTrustedCheckBox.setVisible(webPlatform);

    myEmulatorAdlOptionsLabel.setVisible(mobilePlatform);
    myEmulatorAdlOptionsEditor.setVisible(mobilePlatform);
    myAppDescriptorForEmulatorLabel.setVisible(app && mobilePlatform);
    myAppDescriptorForEmulatorCombo.setVisible(app && mobilePlatform);

    if (webPlatform) {
      myLauncherParametersTextWithBrowse.getTextField().setText(myLauncherParameters.getPresentableText());
    }
  }

  @Override
  protected @NotNull JComponent createEditor() {
    return myMainPanel;
  }

  @Override
  protected void resetEditorFrom(final @NotNull FlexUnitRunConfiguration config) {
    final FlexUnitRunnerParameters params = config.getRunnerParameters();
    myLauncherParameters = params.getLauncherParameters().clone(); // must be before myBCsCombo.setModel()

    myBCCombo.resetFrom(params);
    myWhatToTestForm.resetFrom(myBCCombo.getModule(), myBCCombo.getBC(), params);

    myShowLogCheckBox.setSelected(params.getOutputLogLevel() != null);
    myLogLevelCombo.setEnabled(params.getOutputLogLevel() != null);
    myLogLevelCombo.setSelectedItem(params.getOutputLogLevel());

    myRunTrustedCheckBox.setSelected(params.isTrusted());

    myEmulatorAdlOptionsEditor.setText(params.getEmulatorAdlOptions());
    myAppDescriptorForEmulatorCombo.setSelectedItem(params.getAppDescriptorForEmulator());
  }

  @Override
  protected void applyEditorTo(final @NotNull FlexUnitRunConfiguration config) throws ConfigurationException {
    final FlexUnitRunnerParameters params = config.getRunnerParameters();

    myBCCombo.applyTo(params);
    myWhatToTestForm.applyTo(params);

    final FlexUnitRunnerParameters.OutputLogLevel logLevel = myShowLogCheckBox.isSelected()
                                                             ? (FlexUnitRunnerParameters.OutputLogLevel)myLogLevelCombo.getSelectedItem()
                                                             : null;
    params.setOutputLogLevel(logLevel);
    params.setLauncherParameters(myLauncherParameters);
    params.setTrusted(myRunTrustedCheckBox.isSelected());

    params.setEmulatorAdlOptions(myEmulatorAdlOptionsEditor.getText().trim());
    params.setAppDescriptorForEmulator((FlashRunnerParameters.AppDescriptorForEmulator)myAppDescriptorForEmulatorCombo.getSelectedItem());
  }

  @Override
  protected void disposeEditor() {
    myBCCombo.dispose();
    myWhatToTestForm.dispose();
  }
}

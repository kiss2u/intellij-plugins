// Copyright 2000-2024 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
package com.intellij.lang.javascript.flex.projectStructure.ui;

import com.intellij.flex.FlexCommonUtils;
import com.intellij.flex.build.AirDescriptorOptions;
import com.intellij.javascript.flex.FlexApplicationComponent;
import com.intellij.lang.javascript.flex.FlexBundle;
import com.intellij.lang.javascript.flex.FlexUtils;
import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.fileChooser.FileChooserDescriptorFactory;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.ui.Messages;
import com.intellij.openapi.ui.TextFieldWithBrowseButton;
import com.intellij.openapi.ui.ValidationInfo;
import com.intellij.openapi.util.NullableComputable;
import com.intellij.openapi.util.Ref;
import com.intellij.openapi.util.io.FileUtil;
import com.intellij.openapi.util.text.StringUtil;
import com.intellij.openapi.vfs.LocalFileSystem;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.ui.IdeBorderFactory;
import com.intellij.ui.components.JBTabbedPane;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import com.intellij.util.ArrayUtil;
import com.intellij.util.PathUtil;
import com.intellij.util.ui.UIUtil;
import org.jetbrains.annotations.Nullable;

import javax.swing.BorderFactory;
import javax.swing.ButtonGroup;
import javax.swing.DefaultComboBoxModel;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.JTextField;
import javax.swing.border.TitledBorder;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.IOException;
import java.util.Arrays;
import java.util.regex.Pattern;

import static com.intellij.flex.build.AirDescriptorOptions.ANDROID_PERMISSION_ACCESS_FINE_LOCATION;
import static com.intellij.flex.build.AirDescriptorOptions.ANDROID_PERMISSION_CAMERA;
import static com.intellij.flex.build.AirDescriptorOptions.ANDROID_PERMISSION_INTERNET;
import static com.intellij.flex.build.AirDescriptorOptions.ANDROID_PERMISSION_WRITE_EXTERNAL_STORAGE;

public class CreateAirDescriptorTemplateDialog extends DialogWrapper {

  public static final Pattern VERSION_PATTERN = Pattern.compile("[0-9]{1,3}(\\.[0-9]{1,3}){0,2}");

  private final JPanel myMainPanel;

  private final JTextField myDescriptorFileNameTextField;
  private final TextFieldWithBrowseButton myDescriptorFolderTextWithBrowse;
  private final JComboBox myAirVersionCombo;

  private final JTextField myAppIdTextField;
  private final JTextField myAppNameTextField;
  private final JTextField myAppVersionTextField;

  private final JPanel myMobileOptionsPanel;

  private final JCheckBox myAndroidCheckBox;
  private final JCheckBox myIOSCheckBox;
  private final JCheckBox myAutoOrientCheckBox;
  private final JCheckBox myFullScreenCheckBox;

  private final JBTabbedPane myMobilePlatformsTabs;

  private final JPanel myAndroidPanel;
  private final JCheckBox myAndroidInternetCheckBox;
  private final JCheckBox myAndroidWriteExternalStorageCheckBox;
  private final JCheckBox myAndroidAccessFineLocationCheckBox;
  private final JCheckBox myAndroidCameraCheckBox;

  private final JPanel myIOSPanel;
  private final JRadioButton myIOSAllRadioButton;
  private final JRadioButton myIPhoneRadioButton;
  private final JRadioButton myIPadRadioButton;
  private final JCheckBox myIOSHighResolutionCheckBox;

  private final Project myProject;
  private final String[] myExtensions;

  public CreateAirDescriptorTemplateDialog(final Project project,
                                           final String folderPath,
                                           final String mainClass,
                                           final String airVersion,
                                           final String[] extensions,
                                           final boolean androidEnabled,
                                           final boolean iosEnabled) {
    super(project);
    myProject = project;
    myExtensions = extensions;
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myMainPanel = new JPanel();
      myMainPanel.setLayout(new GridLayoutManager(4, 3, new Insets(0, 0, 0, 0), -1, -1));
      myMobileOptionsPanel = new JPanel();
      myMobileOptionsPanel.setLayout(new GridLayoutManager(3, 4, new Insets(0, 0, 0, 0), -1, -1));
      myMobileOptionsPanel.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithoutIndent");
      myMainPanel.add(myMobileOptionsPanel, new GridConstraints(2, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                                GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                null, null, null, 0, false));
      myMobileOptionsPanel.setBorder(
        IdeBorderFactory.PlainSmallWithoutIndent.createTitledBorder(BorderFactory.createEtchedBorder(), "Mobile options",
                                                                    TitledBorder.DEFAULT_JUSTIFICATION, TitledBorder.DEFAULT_POSITION, null,
                                                                    null));
      myAutoOrientCheckBox = new JCheckBox();
      myAutoOrientCheckBox.setSelected(true);
      myAutoOrientCheckBox.setText("Auto-orient");
      myMobileOptionsPanel.add(myAutoOrientCheckBox, new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                         GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                         GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                         GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myFullScreenCheckBox = new JCheckBox();
      myFullScreenCheckBox.setSelected(true);
      myFullScreenCheckBox.setText("Full screen");
      myMobileOptionsPanel.add(myFullScreenCheckBox, new GridConstraints(1, 2, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                         GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                         GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                         GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myMobilePlatformsTabs = new JBTabbedPane();
      myMobileOptionsPanel.add(myMobilePlatformsTabs,
                               new GridConstraints(2, 0, 1, 4, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                   GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                   GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null,
                                                   null, 0, false));
      myAndroidPanel = new JPanel();
      myAndroidPanel.setLayout(new GridLayoutManager(5, 2, new Insets(0, 0, 0, 0), -1, -1));
      myMobilePlatformsTabs.addTab("Android", myAndroidPanel);
      final JLabel label1 = new JLabel();
      label1.setText("Permissions:");
      myAndroidPanel.add(label1, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                     GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null, null,
                                                     0, false));
      final Spacer spacer1 = new Spacer();
      myAndroidPanel.add(spacer1, new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                      GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      myAndroidCameraCheckBox = new JCheckBox();
      myAndroidCameraCheckBox.setSelected(true);
      myAndroidCameraCheckBox.setText("CAMERA");
      myAndroidPanel.add(myAndroidCameraCheckBox, new GridConstraints(3, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                      GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                      null, null, null, 0, false));
      myAndroidAccessFineLocationCheckBox = new JCheckBox();
      myAndroidAccessFineLocationCheckBox.setSelected(true);
      myAndroidAccessFineLocationCheckBox.setText("ACCESS_FINE_LOCATION");
      myAndroidPanel.add(myAndroidAccessFineLocationCheckBox,
                         new GridConstraints(2, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myAndroidWriteExternalStorageCheckBox = new JCheckBox();
      myAndroidWriteExternalStorageCheckBox.setSelected(true);
      myAndroidWriteExternalStorageCheckBox.setText("WRITE_EXTERNAL_STORAGE");
      myAndroidPanel.add(myAndroidWriteExternalStorageCheckBox,
                         new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myAndroidInternetCheckBox = new JCheckBox();
      myAndroidInternetCheckBox.setSelected(true);
      myAndroidInternetCheckBox.setText("INTERNET");
      myAndroidPanel.add(myAndroidInternetCheckBox, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                        GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                        GridConstraints.SIZEPOLICY_CAN_GROW,
                                                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myIOSPanel = new JPanel();
      myIOSPanel.setLayout(new GridLayoutManager(5, 3, new Insets(0, 0, 0, 0), -1, -1));
      myMobilePlatformsTabs.addTab("iOS", myIOSPanel);
      final Spacer spacer2 = new Spacer();
      myIOSPanel.add(spacer2, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                  GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      myIOSAllRadioButton = new JRadioButton();
      myIOSAllRadioButton.setSelected(true);
      myIOSAllRadioButton.setText("All");
      myIOSPanel.add(myIOSAllRadioButton, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                              GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer3 = new Spacer();
      myIOSPanel.add(spacer3, new GridConstraints(4, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                  GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      final JPanel panel1 = new JPanel();
      panel1.setLayout(new GridLayoutManager(1, 1, new Insets(0, 5, 0, 0), -1, -1));
      myIOSPanel.add(panel1, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                 GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null,
                                                 null, 0, false));
      final JLabel label2 = new JLabel();
      label2.setText("Devices:");
      panel1.add(label2,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myIOSHighResolutionCheckBox = new JCheckBox();
      myIOSHighResolutionCheckBox.setSelected(true);
      myIOSHighResolutionCheckBox.setText("High resolution");
      myIOSPanel.add(myIOSHighResolutionCheckBox, new GridConstraints(3, 0, 1, 3, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                      GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                      null, null, null, 0, false));
      myIPhoneRadioButton = new JRadioButton();
      myIPhoneRadioButton.setText("iPhone/iPod touch");
      myIOSPanel.add(myIPhoneRadioButton, new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                              GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myIPadRadioButton = new JRadioButton();
      myIPadRadioButton.setText("iPad");
      myIOSPanel.add(myIPadRadioButton, new GridConstraints(2, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                            GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                            GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JLabel label3 = new JLabel();
      label3.setText("Common options:");
      myMobileOptionsPanel.add(label3, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                           GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null,
                                                           null, 0, false));
      final JLabel label4 = new JLabel();
      label4.setText("Mobile platform:");
      myMobileOptionsPanel.add(label4, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                           GridConstraints.SIZEPOLICY_FIXED, GridConstraints.SIZEPOLICY_FIXED, null, null,
                                                           null, 0, false));
      myAndroidCheckBox = new JCheckBox();
      myAndroidCheckBox.setSelected(true);
      myAndroidCheckBox.setText("Android");
      myMobileOptionsPanel.add(myAndroidCheckBox, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                      GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                      GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                      null, null, null, 0, false));
      myIOSCheckBox = new JCheckBox();
      myIOSCheckBox.setSelected(true);
      myIOSCheckBox.setText("iOS");
      myMobileOptionsPanel.add(myIOSCheckBox, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK |
                                                                  GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED,
                                                                  null, null, null, 0, false));
      final Spacer spacer4 = new Spacer();
      myMobileOptionsPanel.add(spacer4, new GridConstraints(0, 3, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                                            GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      final JPanel panel2 = new JPanel();
      panel2.setLayout(new GridLayoutManager(3, 3, new Insets(0, 0, 0, 0), -1, -1));
      panel2.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithoutIndent");
      myMainPanel.add(panel2, new GridConstraints(1, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null,
                                                  null, 0, true));
      panel2.setBorder(
        IdeBorderFactory.PlainSmallWithoutIndent.createTitledBorder(BorderFactory.createEtchedBorder(), "Application properties",
                                                                    TitledBorder.DEFAULT_JUSTIFICATION, TitledBorder.DEFAULT_POSITION, null,
                                                                    null));
      final JLabel label5 = new JLabel();
      label5.setText("ID:");
      label5.setDisplayedMnemonic('I');
      label5.setDisplayedMnemonicIndex(0);
      panel2.add(label5,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myAppIdTextField = new JTextField();
      myAppIdTextField.setText("");
      panel2.add(myAppIdTextField, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                       GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null,
                                                       new Dimension(150, -1), null, 0, false));
      final JLabel label6 = new JLabel();
      label6.setText("Name:");
      label6.setDisplayedMnemonic('A');
      label6.setDisplayedMnemonicIndex(1);
      panel2.add(label6,
                 new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myAppNameTextField = new JTextField();
      myAppNameTextField.setText("");
      myAppNameTextField.setToolTipText("The name that is displayed in the AIR application installer");
      panel2.add(myAppNameTextField, new GridConstraints(1, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                         GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null,
                                                         new Dimension(150, -1), null, 0, false));
      myAppVersionTextField = new JTextField();
      myAppVersionTextField.setText("");
      panel2.add(myAppVersionTextField, new GridConstraints(2, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                            GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null,
                                                            new Dimension(150, -1), null, 0, false));
      final Spacer spacer5 = new Spacer();
      panel2.add(spacer5, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      final JLabel label7 = new JLabel();
      label7.setText("Version:");
      label7.setDisplayedMnemonic('E');
      label7.setDisplayedMnemonicIndex(1);
      panel2.add(label7,
                 new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JPanel panel3 = new JPanel();
      panel3.setLayout(new GridLayoutManager(3, 3, new Insets(0, 0, 0, 0), -1, -1));
      panel3.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithoutIndent");
      myMainPanel.add(panel3, new GridConstraints(0, 0, 1, 3, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null,
                                                  null, 0, true));
      panel3.setBorder(
        IdeBorderFactory.PlainSmallWithoutIndent.createTitledBorder(BorderFactory.createEtchedBorder(), "AIR application descriptor",
                                                                    TitledBorder.DEFAULT_JUSTIFICATION, TitledBorder.DEFAULT_POSITION, null,
                                                                    null));
      final JLabel label8 = new JLabel();
      label8.setText("File name:");
      label8.setDisplayedMnemonic('N');
      label8.setDisplayedMnemonicIndex(5);
      panel3.add(label8,
                 new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDescriptorFileNameTextField = new JTextField();
      myDescriptorFileNameTextField.setText("");
      panel3.add(myDescriptorFileNameTextField,
                 new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                     GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(150, -1),
                                     null, 0, false));
      final JLabel label9 = new JLabel();
      label9.setText("Folder:");
      label9.setDisplayedMnemonic('F');
      label9.setDisplayedMnemonicIndex(0);
      panel3.add(label9,
                 new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myDescriptorFolderTextWithBrowse = new TextFieldWithBrowseButton();
      panel3.add(myDescriptorFolderTextWithBrowse,
                 new GridConstraints(1, 1, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                     GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED, null, new Dimension(300, -1),
                                     null, 0, false));
      final Spacer spacer6 = new Spacer();
      panel3.add(spacer6, new GridConstraints(0, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_HORIZONTAL,
                                              GridConstraints.SIZEPOLICY_WANT_GROW, 1, null, null, null, 0, false));
      final JLabel label10 = new JLabel();
      label10.setText("AIR version:");
      label10.setDisplayedMnemonic('V');
      label10.setDisplayedMnemonicIndex(4);
      panel3.add(label10,
                 new GridConstraints(2, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myAirVersionCombo = new JComboBox();
      myAirVersionCombo.setEditable(true);
      panel3.add(myAirVersionCombo, new GridConstraints(2, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                        GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null,
                                                        null, 0, false));
      final Spacer spacer7 = new Spacer();
      myMainPanel.add(spacer7, new GridConstraints(3, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      final Spacer spacer8 = new Spacer();
      myMainPanel.add(spacer8, new GridConstraints(3, 2, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      final Spacer spacer9 = new Spacer();
      myMainPanel.add(spacer9, new GridConstraints(3, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                                   GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
      label5.setLabelFor(myAppIdTextField);
      label6.setLabelFor(myAppNameTextField);
      label7.setLabelFor(myAppVersionTextField);
      label8.setLabelFor(myDescriptorFileNameTextField);
      label9.setLabelFor(myDescriptorFolderTextWithBrowse);
      label10.setLabelFor(myAirVersionCombo);
      ButtonGroup buttonGroup;
      buttonGroup = new ButtonGroup();
      buttonGroup.add(myIPhoneRadioButton);
      buttonGroup.add(myIPadRadioButton);
      buttonGroup.add(myIOSAllRadioButton);
    }
    setTitle(getTitleText());
    setOKButtonText("Create");
    initControls();

    init();

    final String appName = StringUtil.getShortName(mainClass);
    myDescriptorFileNameTextField.setText(appName + "-app.xml");
    myDescriptorFolderTextWithBrowse.setText(FileUtil.toSystemDependentName(folderPath));
    myAirVersionCombo.setSelectedItem(airVersion);
    myAppIdTextField.setText(mainClass);
    myAppNameTextField.setText(appName);
    myAppVersionTextField.setText("0.0.0");
    myAndroidCheckBox.setSelected(androidEnabled);
    UIUtil.applyStyle(UIUtil.ComponentStyle.MINI, myAndroidInternetCheckBox);
    UIUtil.applyStyle(UIUtil.ComponentStyle.MINI, myAndroidWriteExternalStorageCheckBox);
    UIUtil.applyStyle(UIUtil.ComponentStyle.MINI, myAndroidAccessFineLocationCheckBox);
    UIUtil.applyStyle(UIUtil.ComponentStyle.MINI, myAndroidCameraCheckBox);
    myAndroidInternetCheckBox.setSelected(true);
    myAndroidWriteExternalStorageCheckBox.setSelected(false);
    myAndroidAccessFineLocationCheckBox.setSelected(false);
    myAndroidCameraCheckBox.setSelected(false);
    myIOSCheckBox.setSelected(iosEnabled);
    myIOSAllRadioButton.setSelected(true);

    myMobileOptionsPanel.setVisible(androidEnabled || iosEnabled);
    updateControls();
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myMainPanel; }

  private void initControls() {
    myDescriptorFolderTextWithBrowse.addBrowseFolderListener(myProject, FileChooserDescriptorFactory.createSingleFolderDescriptor());

    final String[] items = Arrays.copyOf(ArrayUtil.reverseArray(FlexApplicationComponent.AIR_VERSIONS), 8);
    myAirVersionCombo.setModel(new DefaultComboBoxModel(items));

    final ActionListener listener = new ActionListener() {
      @Override
      public void actionPerformed(final ActionEvent e) {
        updateControls();
      }
    };

    myAndroidCheckBox.addActionListener(listener);
    myIOSCheckBox.addActionListener(listener);
  }

  @Override
  protected JComponent createCenterPanel() {
    return myMainPanel;
  }

  @Override
  protected ValidationInfo doValidate() {
    final String fileName = myDescriptorFileNameTextField.getText().trim();
    if (fileName.isEmpty()) {
      return new ValidationInfo("Descriptor file name not set", myDescriptorFileNameTextField);
    }
    if (!StringUtil.toLowerCase(fileName).endsWith(".xml")) {
      return new ValidationInfo("Descriptor file name must have xml extension", myDescriptorFileNameTextField);
    }

    final String folderPath = myDescriptorFolderTextWithBrowse.getText().trim();
    if (folderPath.isEmpty()) {
      return new ValidationInfo("Folder is not set", myDescriptorFolderTextWithBrowse);
    }
    final VirtualFile dir = LocalFileSystem.getInstance().findFileByPath(folderPath);
    if (dir != null && !dir.isDirectory()) {
      return new ValidationInfo("Folder for AIR descriptor must be specified", myDescriptorFolderTextWithBrowse);
    }

    final String airVersion = ((String)myAirVersionCombo.getSelectedItem()).trim();
    if (airVersion.isEmpty()) {
      return new ValidationInfo("AIR version is not set", myAirVersionCombo);
    }
    if (!VERSION_PATTERN.matcher(airVersion).matches()) {
      return new ValidationInfo("Incorrect AIR version", myAirVersionCombo);
    }

    final String appId = myAppIdTextField.getText().trim();
    if (appId.isEmpty()) {
      return new ValidationInfo("Application ID is required", myAppIdTextField);
    }
    if (!appId.equals(FlexCommonUtils.fixApplicationId(appId))) {
      return new ValidationInfo("Application ID must contain only following symbols: 0-9, a-z, A-Z, '.', '-'", myAppIdTextField);
    }

    if (myAppNameTextField.getText().trim().isEmpty()) {
      return new ValidationInfo("Application name is required", myAppNameTextField);
    }

    final String appVersion = myAppVersionTextField.getText().trim();
    if (appVersion.isEmpty()) {
      return new ValidationInfo("Application version is not set", myAppVersionTextField);
    }
    if (StringUtil.compareVersionNumbers(airVersion, "2.5") >= 0) {
      if (!VERSION_PATTERN.matcher(appVersion).matches()) {
        return new ValidationInfo("Application version must have following format: [0-999].[0-999].[0-999]", myAppVersionTextField);
      }
    }

    return null;
  }

  private void updateControls() {
    UIUtil.setEnabled(myMobilePlatformsTabs.getTabComponentAt(0), myAndroidCheckBox.isSelected(), true);
    UIUtil.setEnabled(myAndroidPanel, myAndroidCheckBox.isSelected(), true);
    UIUtil.setEnabled(myMobilePlatformsTabs.getTabComponentAt(1), myIOSCheckBox.isSelected(), true);
    UIUtil.setEnabled(myIOSPanel, myIOSCheckBox.isSelected(), true);
  }

  @Override
  protected void doOKAction() {
    final String airVersion = ((String)myAirVersionCombo.getSelectedItem()).trim();
    final String appId = myAppIdTextField.getText().trim();
    final String appName = myAppNameTextField.getText().trim();
    final String appVersion = myAppVersionTextField.getText().trim();
    final String swfName = "SWF file name is set automatically at compile time";
    final boolean mobile = myMobileOptionsPanel.isVisible();
    final boolean autoOrients = mobile && myAutoOrientCheckBox.isSelected();
    final boolean fullScreen = mobile && myFullScreenCheckBox.isSelected();
    final boolean android = mobile && myAndroidCheckBox.isSelected();
    final int androidPermissions = !mobile || !android ? 0 :
                                   (myAndroidInternetCheckBox.isSelected() ? ANDROID_PERMISSION_INTERNET : 0)
                                   | (myAndroidWriteExternalStorageCheckBox.isSelected() ? ANDROID_PERMISSION_WRITE_EXTERNAL_STORAGE : 0)
                                   | (myAndroidAccessFineLocationCheckBox.isSelected() ? ANDROID_PERMISSION_ACCESS_FINE_LOCATION : 0)
                                   | (myAndroidCameraCheckBox.isSelected() ? ANDROID_PERMISSION_CAMERA : 0);
    final boolean ios = mobile && myIOSCheckBox.isSelected();
    final boolean iPhone = mobile && ios && (myIOSAllRadioButton.isSelected() || myIPhoneRadioButton.isSelected());
    final boolean iPad = mobile && ios && (myIOSAllRadioButton.isSelected() || myIPadRadioButton.isSelected());
    final boolean iosHighResolution = mobile && ios && myIOSHighResolutionCheckBox.isSelected();

    final AirDescriptorOptions options =
      new AirDescriptorOptions(airVersion, appId, appName, appVersion, swfName, myExtensions,
                               mobile, autoOrients, fullScreen,
                               android, androidPermissions,
                               ios, iPhone, iPad, iosHighResolution);

    if (createAirDescriptorTemplate(myProject, true, getDescriptorPath(), options) != null) {
      super.doOKAction();
    }
  }

  private static @Nullable VirtualFile createAirDescriptorTemplate(final Project project,
                                                                   final boolean interactive,
                                                                   final String descriptorPath,
                                                                   final AirDescriptorOptions options) {
    final VirtualFile dir = FlexUtils.createDirIfMissing(project, interactive, PathUtil.getParentPath(descriptorPath), getTitleText());
    if (dir == null) return null;

    final String fileName = PathUtil.getFileName(descriptorPath);

    final VirtualFile file = dir.findChild(fileName);
    if (file != null) {
      if (file.isDirectory()) {
        if (interactive) {
          Messages.showErrorDialog(project, "Can't create AIR descriptor file.\nFolder with such name exists.", getTitleText());
        }
        return null;
      }
      final int choice = interactive
                         ? Messages.showYesNoDialog(project, FlexBundle.message("file.exists.replace.question", fileName),
                                                    getTitleText(), Messages.getQuestionIcon())
                         : Messages.YES;
      if (choice != Messages.YES) {
        return null;
      }
    }

    try {
      final Ref<VirtualFile> fileRef = new Ref<>();
      final IOException exception = ApplicationManager.getApplication().runWriteAction((NullableComputable<IOException>)() -> {
        try {
          fileRef.set(FlexUtils.addFileWithContent(fileName, options.getAirDescriptorText(), dir));
        }
        catch (IOException e) {
          return e;
        }
        return null;
      });

      if (exception != null) {
        throw exception;
      }

      return fileRef.get();
    }
    catch (IOException e) {
      if (interactive) {
        Messages.showErrorDialog(project, "Failed to create AIR descriptor file: " + e.getMessage(), getTitleText());
      }
      return null;
    }
  }

  public String getDescriptorPath() {
    return FileUtil.toSystemIndependentName(myDescriptorFolderTextWithBrowse.getText().trim() + "/" +
                                            myDescriptorFileNameTextField.getText().trim());
  }

  public boolean isBothAndroidAndIosSelected() {
    return myAndroidCheckBox.isVisible() && myAndroidCheckBox.isSelected() && myIOSCheckBox.isVisible() && myIOSCheckBox.isSelected();
  }

  @Override
  protected String getHelpId() {
    return "flex.CreateAirDescriptorTemplateDialog";
  }

  static String getTitleText() {
    return FlexBundle.message("create.air.descriptor.template.title");
  }
}

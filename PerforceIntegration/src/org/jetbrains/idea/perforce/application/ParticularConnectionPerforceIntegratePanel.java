/*
 * Copyright 2000-2005 JetBrains s.r.o.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.jetbrains.idea.perforce.application;

import com.google.common.annotations.VisibleForTesting;
import com.intellij.openapi.diagnostic.Logger;
import com.intellij.openapi.options.ConfigurationException;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.ui.Messages;
import com.intellij.openapi.util.NlsSafe;
import com.intellij.openapi.vcs.VcsException;
import com.intellij.openapi.vcs.changes.committed.ChangesBrowserDialog;
import com.intellij.openapi.vcs.changes.committed.CommittedChangesTableModel;
import com.intellij.ui.IdeBorderFactory;
import com.intellij.ui.components.JBScrollPane;
import com.intellij.uiDesigner.core.GridConstraints;
import com.intellij.uiDesigner.core.GridLayoutManager;
import com.intellij.uiDesigner.core.Spacer;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.idea.perforce.PerforceBundle;
import org.jetbrains.idea.perforce.perforce.BranchSpec;
import org.jetbrains.idea.perforce.perforce.ChangeListChooser;
import org.jetbrains.idea.perforce.perforce.P4File;
import org.jetbrains.idea.perforce.perforce.ParticularConnectionSettings;
import org.jetbrains.idea.perforce.perforce.PerforceChangeList;
import org.jetbrains.idea.perforce.perforce.PerforceRunner;
import org.jetbrains.idea.perforce.perforce.PerforceSettings;
import org.jetbrains.idea.perforce.perforce.connections.P4Connection;

import javax.swing.AbstractButton;
import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextArea;
import javax.swing.border.TitledBorder;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.lang.reflect.Method;
import java.util.Collections;
import java.util.List;
import java.util.Objects;
import java.util.ResourceBundle;

public class ParticularConnectionPerforceIntegratePanel implements PerforcePanel {
  private static final Logger LOG =
    Logger.getInstance(ParticularConnectionPerforceIntegratePanel.class);
  private final Project myProject;
  private final JComboBox myBranches;
  private final JComboBox myChangeLists;
  private final JButton myNewChangeListButton;
  private final JPanel myPanel;
  private final ChangeListChooser myChangeListChooser;
  private final JCheckBox myUsingChangeList;
  private final JCheckBox myIsReverse;
  private final JTextArea myBranchSpecDescription;

  private final JLabel myIntegrateWithChangeListLabel;
  private final P4Connection myConnection;
  private final PerforceRunner myRunner;

  public ParticularConnectionPerforceIntegratePanel(final Project project, final @NotNull P4Connection connection) {
    myProject = project;
    {
      // GUI initializer generated by IntelliJ IDEA GUI Designer
      // >>> IMPORTANT!! <<<
      // DO NOT EDIT OR ADD ANY CODE HERE!
      myPanel = new JPanel();
      myPanel.setLayout(new GridLayoutManager(2, 2, new Insets(0, 0, 0, 0), -1, -1));
      final JPanel panel1 = new JPanel();
      panel1.setLayout(new GridLayoutManager(2, 2, new Insets(0, 0, 0, 0), -1, -1));
      panel1.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithIndent");
      myPanel.add(panel1, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                              0, false));
      panel1.setBorder(IdeBorderFactory.PlainSmallWithIndent.createTitledBorder(BorderFactory.createEtchedBorder(),
                                                                                this.$$$getMessageFromBundle$$$("messages/PerforceBundle",
                                                                                                                "configure.integrate.branch.spec.title"),
                                                                                TitledBorder.DEFAULT_JUSTIFICATION,
                                                                                TitledBorder.DEFAULT_POSITION, null, null));
      myBranches = new JComboBox();
      panel1.add(myBranches, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                 GridConstraints.SIZEPOLICY_WANT_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null,
                                                 0, false));
      myIsReverse = new JCheckBox();
      this.$$$loadButtonText$$$(myIsReverse,
                                this.$$$getMessageFromBundle$$$("messages/PerforceBundle", "configure.integrate.reverse.checkbox"));
      panel1.add(myIsReverse, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                  GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                  GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JBScrollPane jBScrollPane1 = new JBScrollPane();
      jBScrollPane1.setEnabled(true);
      jBScrollPane1.setWheelScrollingEnabled(true);
      panel1.add(jBScrollPane1, new GridConstraints(1, 0, 1, 2, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                                    GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW,
                                                    GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW,
                                                    new Dimension(-1, 100), null, null, 0, false));
      myBranchSpecDescription = new JTextArea();
      myBranchSpecDescription.setEditable(false);
      jBScrollPane1.setViewportView(myBranchSpecDescription);
      final JPanel panel2 = new JPanel();
      panel2.setLayout(new GridLayoutManager(2, 1, new Insets(0, 0, 0, 0), -1, -1));
      myPanel.add(panel2, new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_NONE,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                              GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                              0, false));
      final JPanel panel3 = new JPanel();
      panel3.setLayout(new GridLayoutManager(1, 2, new Insets(0, 0, 0, 0), -1, -1));
      panel3.putClientProperty("BorderFactoryClass", "com.intellij.ui.IdeBorderFactory$PlainSmallWithIndent");
      panel2.add(panel3, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                             0, false));
      panel3.setBorder(IdeBorderFactory.PlainSmallWithIndent.createTitledBorder(BorderFactory.createEtchedBorder(),
                                                                                this.$$$getMessageFromBundle$$$("messages/PerforceBundle",
                                                                                                                "configure.integrate.store.changes.to.change.list.group.title"),
                                                                                TitledBorder.DEFAULT_JUSTIFICATION,
                                                                                TitledBorder.DEFAULT_POSITION, null, null));
      myChangeLists = new JComboBox();
      panel3.add(myChangeLists, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                                    GridConstraints.SIZEPOLICY_CAN_GROW, GridConstraints.SIZEPOLICY_FIXED, null, null, null,
                                                    0, false));
      myNewChangeListButton = new JButton();
      this.$$$loadButtonText$$$(myNewChangeListButton, this.$$$getMessageFromBundle$$$("messages/PerforceBundle", "button.text.new"));
      panel3.add(myNewChangeListButton,
                 new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_NONE, GridConstraints.SIZEPOLICY_FIXED,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final JPanel panel4 = new JPanel();
      panel4.setLayout(new GridLayoutManager(1, 2, new Insets(0, 0, 0, 0), -1, -1));
      panel2.add(panel4, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_BOTH,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                             GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW, null, null, null,
                                             0, false));
      myUsingChangeList = new JCheckBox();
      this.$$$loadButtonText$$$(myUsingChangeList, this.$$$getMessageFromBundle$$$("messages/PerforceBundle",
                                                                                   "configure.integrate.integrate.change.list.label"));
      panel4.add(myUsingChangeList, new GridConstraints(0, 0, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_NONE,
                                                        GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_CAN_GROW,
                                                        GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      myIntegrateWithChangeListLabel = new JLabel();
      myIntegrateWithChangeListLabel.setText("###");
      panel4.add(myIntegrateWithChangeListLabel,
                 new GridConstraints(0, 1, 1, 1, GridConstraints.ANCHOR_WEST, GridConstraints.FILL_HORIZONTAL,
                                     GridConstraints.SIZEPOLICY_CAN_SHRINK | GridConstraints.SIZEPOLICY_WANT_GROW,
                                     GridConstraints.SIZEPOLICY_FIXED, null, null, null, 0, false));
      final Spacer spacer1 = new Spacer();
      myPanel.add(spacer1, new GridConstraints(1, 0, 1, 1, GridConstraints.ANCHOR_CENTER, GridConstraints.FILL_VERTICAL, 1,
                                               GridConstraints.SIZEPOLICY_WANT_GROW, null, null, null, 0, false));
    }
    myChangeListChooser = new ChangeListChooser(myChangeLists, myNewChangeListButton, project, connection);
    myConnection = connection;
    myRunner = PerforceRunner.getInstance(project);

    myUsingChangeList.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        if (myUsingChangeList.isSelected()) {
          PerforceChangeList selectedChangeList = chooseChangeList(project);

          if (selectedChangeList != null) {
            myIntegrateWithChangeListLabel.setText(String.valueOf(selectedChangeList.getNumber()));
          }
          else {
            myIntegrateWithChangeListLabel.setText("");
            myUsingChangeList.setSelected(false);
          }
        }
        else {
          myIntegrateWithChangeListLabel.setText("");
        }
      }
    });

    myBranches.addActionListener(new ActionListener() {
      @Override
      public void actionPerformed(ActionEvent e) {
        final String selectedBranchName = getSelectedBranchName();
        if (selectedBranchName == null) {
          myBranchSpecDescription.setText(PerforceBundle.message("no.branch.spec.selected.label.text"));
        }
        else {
          try {
            BranchSpec branchSpec = myRunner.loadBranchSpec(selectedBranchName, connection);
            myBranchSpecDescription.setText(composeBranchSpecText(branchSpec));
          }
          catch (VcsException e1) {
            myBranchSpecDescription.setText(
              PerforceBundle.message("cannot.load.branch.spec.description.error.text", e1.getLocalizedMessage()));
          }
        }
      }
    });
  }

  private static Method $$$cachedGetBundleMethod$$$ = null;

  /** @noinspection ALL */
  private String $$$getMessageFromBundle$$$(String path, String key) {
    ResourceBundle bundle;
    try {
      Class<?> thisClass = this.getClass();
      if ($$$cachedGetBundleMethod$$$ == null) {
        Class<?> dynamicBundleClass = thisClass.getClassLoader().loadClass("com.intellij.DynamicBundle");
        $$$cachedGetBundleMethod$$$ = dynamicBundleClass.getMethod("getBundle", String.class, Class.class);
      }
      bundle = (ResourceBundle)$$$cachedGetBundleMethod$$$.invoke(null, path, thisClass);
    }
    catch (Exception e) {
      bundle = ResourceBundle.getBundle(path);
    }
    return bundle.getString(key);
  }

  /** @noinspection ALL */
  private void $$$loadButtonText$$$(AbstractButton component, String text) {
    StringBuffer result = new StringBuffer();
    boolean haveMnemonic = false;
    char mnemonic = '\0';
    int mnemonicIndex = -1;
    for (int i = 0; i < text.length(); i++) {
      if (text.charAt(i) == '&') {
        i++;
        if (i == text.length()) break;
        if (!haveMnemonic && text.charAt(i) != '&') {
          haveMnemonic = true;
          mnemonic = text.charAt(i);
          mnemonicIndex = result.length();
        }
      }
      result.append(text.charAt(i));
    }
    component.setText(result.toString());
    if (haveMnemonic) {
      component.setMnemonic(mnemonic);
      component.setDisplayedMnemonicIndex(mnemonicIndex);
    }
  }

  /** @noinspection ALL */
  public JComponent $$$getRootComponent$$$() { return myPanel; }

  private @Nullable String getSelectedBranchName() {
    return (String)myBranches.getSelectedItem();
  }

  private PerforceChangeList chooseChangeList(Project project) {
    try {
      List<PerforceChangeList> changes = getChangesToIntegrate(getSelectedBranchName(), myIsReverse.isSelected());
      PerforceCommittedChangesProvider provider = PerforceVcs.getInstance(project).getCommittedChangesProvider();
      //noinspection unchecked
      final CommittedChangesTableModel model = new CommittedChangesTableModel((List)changes, provider.getColumns(), false);
      final ChangesBrowserDialog dlg = new ChangesBrowserDialog(project, model, ChangesBrowserDialog.Mode.Choose, null);
      return dlg.showAndGet() ? (PerforceChangeList)dlg.getSelectedChangeList() : null;
    }
    catch (VcsException e) {
      LOG.info(e);
      return null;
    }
  }

  @VisibleForTesting
  public List<PerforceChangeList> getChangesToIntegrate(String branchName, final boolean reverse) throws VcsException {
    List<String> fileSpecs = branchName != null
                             ? myRunner.getBranchViews(branchName, reverse, myConnection)
                             : Collections.singletonList(P4File.create(myProject.getBaseDir()).getRecursivePath());

    return myRunner.getSubmittedChangeLists(myConnection, null, null, -1, false, fileSpecs);
  }

  private static String composeBranchSpecText(final BranchSpec branchSpec) {
    final StringBuilder result = new StringBuilder();
    result.append(branchSpec.getDescription());
    result.append(" (");
    result.append(PerforceBundle.message("configure.integrate.branch.spec.description.part.created.by", branchSpec.getOwner()));
    result.append(")");
    result.append("\n");
    for (String view : branchSpec.getViews()) {
      result.append("\n");
      result.append(view);
    }

    return result.toString();
  }


  @Override
  public void updateFrom(PerforceSettings settings) {

    myBranches.removeAllItems();

    final ParticularConnectionSettings connectionSettings = settings.getSettings(myConnection);


    try {
      List<String> branches = myRunner.getBranches(myConnection);

      for (@NlsSafe String branch : branches) {
        //noinspection unchecked
        myBranches.addItem(branch);
      }

      myBranches.setSelectedItem(connectionSettings.INTEGRATE_BRANCH_NAME);

      if (myBranches.getSelectedIndex() < 0 && myBranches.getItemCount() > 0) {
        myBranches.setSelectedIndex(0);
      }
    }
    catch (VcsException e) {
      Messages.showErrorDialog(PerforceBundle.message("integrate.configurable.cannot.load.branches.error.message", e.getLocalizedMessage()),
                               PerforceBundle.message("integrate.configurable.load.branches.dialog.title"));
    }

    try {
      myChangeListChooser.fillChangeLists(myRunner.getPendingChangeLists(myConnection), 0);
    }
    catch (VcsException e1) {
      Messages.showErrorDialog(PerforceBundle.message("message.text.cannot.load.changes", e1.getLocalizedMessage()),
                               PerforceBundle.message("message.title.refresh.changes"));
    }

    myIsReverse.setSelected(connectionSettings.INTEGRATE_REVERSE);

    List<PerforceChangeList> changeLists;
    try {
      changeLists = getChangesToIntegrate(getSelectedBranchName(), myIsReverse.isSelected());
    }
    catch (VcsException e) {
      LOG.info(e);
      changeLists = Collections.emptyList();
    }

    boolean isChangeExists = connectionSettings.INTEGRATE_CHANGE_LIST && changeLists.stream()
      .anyMatch(it -> String.valueOf(it.getNumber()).equals(connectionSettings.INTEGRATED_CHANGE_LIST_NUMBER));
    myUsingChangeList.setSelected(isChangeExists);
    myIntegrateWithChangeListLabel.setText(isChangeExists ? connectionSettings.INTEGRATED_CHANGE_LIST_NUMBER : "");
  }

  @Override
  public void applyTo(PerforceSettings settings) throws ConfigurationException {
    if (myBranches.getSelectedItem() == null) {
      throw new ConfigurationException(PerforceBundle.message("configure.integrate.branchspec.none.selected"));
    }
    final ParticularConnectionSettings connectionSettings = settings.getSettings(myConnection);

    connectionSettings.INTEGRATE_BRANCH_NAME = (String)myBranches.getSelectedItem();
    saveSettings(connectionSettings);
  }

  @Override
  public void cancel(PerforceSettings settings) {
    final ParticularConnectionSettings connectionSettings = settings.getSettings(myConnection);

    if (myBranches.getSelectedItem() != null) {
      connectionSettings.INTEGRATE_BRANCH_NAME = (String)myBranches.getSelectedItem();
    }
    saveSettings(connectionSettings);
  }

  private void saveSettings(ParticularConnectionSettings connectionSettings) {
    connectionSettings.INTEGRATE_TO_CHANGELIST_NUM = myChangeListChooser.getChangeListNumber();

    connectionSettings.INTEGRATED_CHANGE_LIST_NUMBER = myIntegrateWithChangeListLabel.getText();
    connectionSettings.INTEGRATE_CHANGE_LIST = myUsingChangeList.isSelected();
    connectionSettings.INTEGRATE_REVERSE = myIsReverse.isSelected();
  }

  @Override
  public boolean isModified(PerforceSettings settings) {
    final ParticularConnectionSettings connectionSettings = settings.getSettings(myConnection);

    return !Objects.equals(connectionSettings.INTEGRATE_BRANCH_NAME, myBranches.getSelectedItem()) ||
           connectionSettings.INTEGRATE_TO_CHANGELIST_NUM != myChangeListChooser.getChangeListNumber() ||
           !Objects.equals(connectionSettings.INTEGRATED_CHANGE_LIST_NUMBER, myIntegrateWithChangeListLabel.getText()) ||
           connectionSettings.INTEGRATE_CHANGE_LIST != myUsingChangeList.isSelected() ||
           connectionSettings.INTEGRATE_REVERSE != myIsReverse.isSelected();
  }

  @Override
  public JPanel getPanel() {
    return myPanel;
  }
}
